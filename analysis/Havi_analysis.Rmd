---
title: "Havi Fecundity Analysis"
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
  html_document:
    toc: true
    toc_float: true
  word_document:
    toc: true
    keep_md: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list, tidy = TRUE, fig.align = "center", # Always relative to the document directory
                      fig.path = "../figures/", # Send any figures to this folder
                      dev = "pdf",  # Export figures as PDF
                      width = 1,
                      height = 2,
                      dpi = 350)  # Set the resolution to 300 dots per inch (dpi)
```

# Load Libraries

```{r load-packages}
pacman::p_load(cowplot, broom, dplyr, devtools, emmeans, ggbeeswarm, ggpmisc, ggplot2, knitr, lme4, lmerTest, readr, readxl, tidyr, tidyverse, install = FALSE)
```

# Load Data

```{r load-data}
aphid_count <- read_excel("data/fecundity_assay_count.xlsx") %>%
  filter(alate_alive_r1!="control") %>%
  filter(block!=1) %>%
  mutate(
    nymphs_r1 = as.numeric(nymphs_r1),
    nymphs_r2 = as.numeric(nymphs_r2)
  )

# filter by block
aphid_count_block2 <- aphid_count %>%
  filter(block == 2) 
aphid_count_block3 <- aphid_count %>%
  filter(block == 3) 

# === Pivot to long format ===
aphid_long <- aphid_count %>%
  pivot_longer(
    cols = c(starts_with("nymphs_r"), starts_with("alate_alive_r")),
    names_to = c(".value", "round"),
    names_pattern = "(.*)_r(\\d)"
  )
```

# Calculations
Calculating how many aphids are in each group as a new data frame

## survival
```{r death_count}
# === Survival summary by block and round ===
survival_summary <- aphid_long %>%
  group_by(treatment, block, round) %>%  # Group data by treatment condition, experimental block, and round
  summarise(
    # Count how many alates were alive in each group (handling NAs just in case)
    alive_n = sum(alate_alive == "Yes", na.rm = TRUE),
    # Count how many alates were dead in each group
    dead_n  = sum(alate_alive == "No",  na.rm = TRUE),
    # Compute total number of alates observed (alive + dead)
    total   = alive_n + dead_n,
    # Calculate percent survival per block per round (0–100%)
    survival_pct = 100 * alive_n / total,
    # Drop grouping structure after summarising (avoids nested data frames in later steps)
    .groups = "drop"
  )

# === Average survival across blocks ===
survival_summary_avg <- survival_summary %>%
  group_by(treatment, round) %>%  # Now group just by treatment and round (collapsed across blocks)
  summarise(
    # Compute the mean survival percentage across all blocks in each treatment/round
    mean_survival = mean(survival_pct, na.rm = TRUE),
    # Calculate standard error: standard deviation divided by square root of the number of blocks
    se_survival   = sd(survival_pct, na.rm = TRUE) / sqrt(n()),
    # Drop grouping again for a clean summary table
    .groups = "drop"
  )
```

## fecundity
```{r fecundity-calc}
# === block level ===
fecundity_by_block <- aphid_long %>%
  filter(!is.na(nymphs)) %>%  # Remove missing nymph count entries

  # Group by treatment, round, and block to calculate within-block variation
  group_by(treatment, block, round) %>%
  summarise(
    mean_fecundity = mean(nymphs, na.rm = TRUE),              # Mean number of nymphs per alate in that block
    se_fecundity   = sd(nymphs, na.rm = TRUE) / sqrt(n()),    # Standard error of nymph counts in that block
    n              = n(),                                     # Number of alates (i.e., observations)
    .groups = "drop"
  )

# === treatment level ===
fecundity_by_treatment <- aphid_long %>%
  filter(!is.na(nymphs)) %>%  # Exclude missing nymph counts

  # Step 1: Group by treatment, round, and block to compute block-level means
  group_by(treatment, block, round) %>%
  # Step 2: Group by treatment and round to compute treatment-level summaries
  group_by(treatment, round) %>%
  summarise(
    mean_fecundity = mean(nymphs, na.rm = TRUE),          # Mean of block means
    se_fecundity   = sd(nymphs, na.rm = TRUE) / sqrt(n()), # Standard error across blocks
        n              = n(),                                     # Number of alates (i.e., observations)
    .groups = "drop"
  )
```

# Plot

## Plot aphid survival

```{r plot-aphid-survival-r1}
# Filter by block
survival_summary_block2 <- survival_summary %>% filter(block==2)
survival_summary_block3 <- survival_summary %>% filter(block==3)

# === Block 2 ===
ggplot(data = survival_summary_block2, aes(x = interaction(treatment, round), y = survival_pct, fill = treatment)) +
  geom_col(color = "black", size = 0.3) +
  labs(x = "Treatment", y = "Alate Survival %", 
       title = "Aphid Survival on #220 or buffer plants - Block 2") +
  scale_fill_manual(values = c("#546214", "#844e27")) +
  ylim(0, 100) +
  theme_minimal() +
  theme(legend.position = "right", panel.background = element_rect(fill = "white"), panel.grid = element_blank(),
  panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5))

# === Block 3 ===
ggplot(data = survival_summary_block3, aes(x = interaction(treatment, round), y = survival_pct, fill = treatment)) +
  geom_col(color = "black", size = 0.3) +
  labs(x = "Treatment", y = "Alate Survival %", 
       title = "Aphid Survival on #220 or buffer plants - Block 3") +
  scale_fill_manual(values = c("#546214", "#844e27")) +
  ylim(0, 100) +
  theme_minimal() +
  theme(legend.position = "right", panel.background = element_rect(fill = "white"), panel.grid = element_blank(),
  panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5))

# === All Blocks ===
ggplot(survival_summary_avg, aes(x = interaction(treatment, round), y = mean_survival, fill = treatment)) +
  geom_col(color = "black", size = 0.3, position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = mean_survival - se_survival, ymax = mean_survival + se_survival),
                width = 0.2, color = "black", position = position_dodge(width = 0.9)) +
  labs(x = "Treatment × Round", y = "Mean Alate Survival (%)", 
       title = "Mean Aphid Survival Across Blocks") +
  scale_fill_manual(values = c("#546214", "#844e27")) +
  ylim(0, 100) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.background = element_rect(fill = "white"),
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```

## Plot aphid fecundity
### Column Plots

```{r col-plot-aphid-fecundity}
# === Block 2 ===
fecundity_by_block_block2 <- fecundity_by_block %>% filter(block==2)
ggplot(data = fecundity_by_block_block2, aes(x = interaction(treatment, round), y = mean_fecundity, fill = treatment)) +
  geom_col(color = "black", size = 0.3) +
  geom_errorbar(aes(ymin = mean_fecundity - se_fecundity, ymax = mean_fecundity + se_fecundity), width = 0.2, color = "black", position = position_dodge(width = 0.8)) +
  labs(x = "Treatment", y = "Nymphs per Alate", 
       title = "Aphid Fecundity on #220 or buffer plants - Block 2") +
  scale_fill_manual(values = c("#546214", "#844e27")) +
  ylim(0, 50) +
  theme_minimal() +
  theme(legend.position = "right", panel.background = element_rect(fill = "white"), panel.grid = element_blank(),
  panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5))


# === Block 3 ===
fecundity_by_block_block3 <- fecundity_by_block %>% filter(block==3)
ggplot(data = fecundity_by_block_block3, aes(x = interaction(treatment, round), y = mean_fecundity, fill = treatment)) +
  geom_col(color = "black", size = 0.3) +
  geom_errorbar(aes(ymin = mean_fecundity - se_fecundity, ymax = mean_fecundity + se_fecundity), width = 0.2, color = "black", position = position_dodge(width = 0.8)) +
  labs(x = "Treatment", y = "Nymphs per Alate", 
       title = "Aphid Fecundity on #220 or buffer plants - Block 3") +
  scale_fill_manual(values = c("#546214", "#844e27")) +
  ylim(0, 50) +
  theme_minimal() +
  theme(legend.position = "right", panel.background = element_rect(fill = "white"), panel.grid = element_blank(),
  panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5))

# === All Blocks ===
ggplot(data = fecundity_by_treatment, aes(x = interaction(treatment, round), y = mean_fecundity, fill = treatment)) +
  geom_col(color = "black", size = 0.3) +
  geom_errorbar(aes(ymin = mean_fecundity - se_fecundity, ymax = mean_fecundity + se_fecundity), width = 0.2, color = "black", position = position_dodge(width = 0.8)) +
  labs(x = "Treatment", y = "Nymphs per Alate", 
       title = "Aphid Fecundity on #220 or buffer plants - Block 3") +
  scale_fill_manual(values = c("#546214", "#844e27")) +
  ylim(0, 50) +
  theme_minimal() +
  theme(legend.position = "right", panel.background = element_rect(fill = "white"), panel.grid = element_blank(),
  panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5))
```

### Violin plots
```{r violin-plot-aphid-fecundity}
# === Violin Plot per block ===
ggplot(aphid_long, aes(x = interaction(treatment, round), y = nymphs, fill = treatment)) +
  # Violin geometry: distribution shape
  geom_violin(trim = FALSE, alpha = 0.6, color = "black") +
  # Overlay individual data points, jittered for visibility
  geom_jitter(aes(color = alate_alive), width = 0.2, size = 0.8) +
  # Facet by block to compare spatial replicates
  facet_wrap(~ block, nrow = 1) +
  # Axis labels and plot title
  labs(
    x = "Treatment × Round",
    y = "Nymphs per Alate",
    title = "Distribution of Aphid Fecundity by Treatment, Round, and Block"
  ) +
  # Consistent fill and point colors
  scale_fill_manual(values = c("220" = "#546214", "MgCl2" = "#844e27")) +
  scale_color_manual(values = c("Yes" = "#b4dc7a", "No" = "#e95d4d")) +
  # Theme cleanup
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# === Violin Plot overall ===
ggplot(aphid_long, aes(x = interaction(treatment, round), y = nymphs, fill = treatment)) +
  # Violin geometry: distribution shape
  geom_violin(trim = FALSE, alpha = 1, color = "black") +
  # Overlay individual data points, jittered for visibility
  geom_jitter(aes(color = alate_alive), width = 0.2, size = 0.8) +
  # Axis labels and plot title
  labs(
    x = "Treatment × Round",
    y = "Nymphs per Alate",
    title = "Distribution of Aphid Fecundity by Treatment, Round, and Block"
  ) +
  # Consistent fill and point colors
  scale_fill_manual(values = c("220" = "#546214", "MgCl2" = "#844e27")) +
  scale_color_manual(values = c("Yes" = "#b4dc7a", "No" = "#e95d4d")) +
  # Theme cleanup
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

# Statistics

## Prepare the data and define helper function
```{r prepare-data-stats}
# Identify unique blocks in your dataset
blocks <- unique(aphid_count$block)

# This function takes a subset of the data (e.g., one block or full data)
# and prints model summaries for survival and fecundity across both rounds
analyze_block <- function(df, label = "All Blocks") {
  cat("\n===============================", label, "===============================\n")
  
  # -------------------- Survival: Round 1 --------------------
  cat("\n--- Survival Round 1 ---\n")
  surv_r1 <- df %>%
    group_by(treatment) %>%
    summarise(
      alive_n = sum(alate_alive_r1 == "Yes", na.rm = TRUE),
      dead_n  = sum(alate_alive_r1 == "No",  na.rm = TRUE),
      .groups = "drop"
    )
  ch_r1 <- glm(cbind(alive_n, dead_n) ~ treatment, family = binomial, data = surv_r1)
  print(summary(ch_r1))
  print(emmeans(ch_r1, ~ treatment, type = "response"))
  
  # -------------------- Survival: Round 2 --------------------
  cat("\n--- Survival Round 2 ---\n")
  surv_r2 <- df %>%
    group_by(treatment) %>%
    summarise(
      alive_n = sum(alate_alive_r2 == "Yes", na.rm = TRUE),
      dead_n  = sum(alate_alive_r2 == "No",  na.rm = TRUE),
      .groups = "drop"
    )
  ch_r2 <- glm(cbind(alive_n, dead_n) ~ treatment, family = binomial, data = surv_r2)
  print(summary(ch_r2))
  print(emmeans(ch_r2, ~ treatment, type = "response"))
  
  # -------------------- Fecundity: Round 1 --------------------
  cat("\n--- Fecundity Round 1 (Alive Only) ---\n")
  fec_r1_alive <- df %>% filter(alate_alive_r1 == "Yes")
  ch_fec_r1_alive <- lm(nymphs_r1 ~ treatment, data = fec_r1_alive)
  print(summary(ch_fec_r1_alive))
  print(emmeans(ch_fec_r1_alive, ~ treatment))
  
  cat("\n--- Fecundity Round 1 (All Alates) ---\n")
  ch_fec_r1 <- lm(nymphs_r1 ~ treatment, data = df)
  print(summary(ch_fec_r1))
  print(emmeans(ch_fec_r1, ~ treatment))
  
  # -------------------- Fecundity: Round 2 --------------------
  cat("\n--- Fecundity Round 2 (Alive Only) ---\n")
  fec_r2_alive <- df %>% filter(alate_alive_r2 == "Yes")
  ch_fec_r2_alive <- lm(nymphs_r2 ~ treatment, data = fec_r2_alive)
  print(summary(ch_fec_r2_alive))
  print(emmeans(ch_fec_r2_alive, ~ treatment))
  
  cat("\n--- Fecundity Round 2 (All Alates) ---\n")
  ch_fec_r2 <- lm(nymphs_r2 ~ treatment, data = df)
  print(summary(ch_fec_r2))
  print(emmeans(ch_fec_r2, ~ treatment))
}
```

## Stats 

### Individual blocks
```{r block-analysis}
# Loop through each block and run the full analysis
for (blk in blocks) {
  df_blk <- aphid_count %>% filter(block == blk)
  analyze_block(df_blk, paste("Block", blk))
}
```

### All blocks combines
```{r all-blocks-stats}
# Run the same analysis on the entire dataset (all blocks together)
analyze_block(aphid_count, "All Blocks Combined")
```